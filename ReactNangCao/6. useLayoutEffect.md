# useLayoutEffect

C√°ch d√πng `useLayoutEffect` t∆∞∆°ng t·ª± nh∆∞ `useEffect`, nh∆∞ng callback b√™n `useLayoutEffect` s·∫Ω ch·∫°y sau khi render v√† tr∆∞·ªõc khi tr√¨nh duy·ªát paint

99% trong c√°c tr∆∞·ªùng h·ª£p ch√∫ng ta s·∫Ω d√πng `useEffect`, v·∫≠y ch√∫ng ta d√πng `useLayoutEffect` khi n√†o?

Khi browser c·ªßa ch√∫ng ta b·ªã hi·ªán t∆∞·ª£ng flicker (ch·ªõp nh√°y) do ch√∫ng ta thay ƒë·ªïi state qu√° nhanh.

Kh√¥ng n√™n d√πng `useLayoutEffect` ƒë·ªÉ th·ª±c hi·ªán c√°c effect nh∆∞ fetchAPI r·ªìi set l·∫°i state, v√¨ d√πng `useLayoutEffect` ch·∫°y ƒë·ªìng b·ªô, n√≥ s·∫Ω l√†m app b·ªã blocking. H·∫ßu h·∫øt c√°c effect ch√∫ng ta kh√¥ng c·∫ßn t·∫°m ng∆∞ng ƒë·ªÉ ch·∫°y, c√≥ th·ªÉ ch·∫°y b·∫•t ƒë·ªìng b·ªô, v·∫≠y n√™n d√πng `useEffect` th√¨ h·ª£p l√Ω h∆°n

Tham kh·∫£o: [https://daveceddia.com/useeffect-vs-uselayouteffect/](https://daveceddia.com/useeffect-vs-uselayouteffect/)

## Kh√°i ni·ªám v·ªÅ useLayoutEffect r√µ r√†ng, chi ti·∫øt nh·∫•t ?

- üëâ Trong `React`, hook `useLayoutEffect()` ƒë∆∞·ª£c s·ª≠ d·ª•ng ƒë·ªÉ th·ª±c hi·ªán c√°c `side-effect` sau khi DOM ƒë√£ ƒë∆∞·ª£c c·∫≠p nh·∫≠t nh∆∞ng tr∆∞·ªõc khi giao di·ªán ng∆∞·ªùi d√πng ƒë∆∞·ª£c `render` l·∫°i.

- üëâ C√°c `side-effect` bao g·ªìm c√°c thao t√°c tr√™n DOM nh∆∞ `t√≠nh to√°n layout`,` ƒë·ªçc k√≠ch th∆∞·ªõc c·ªßa ph·∫ßn t·ª≠`, ho·∫∑c `th·ª±c hi·ªán c√°c thao t√°c ƒë·ªìng b·ªô` kh√°c.

- üëâ S·ª± kh√°c bi·ªát gi·ªØa `useLayoutEffect()` v√† `useEffect()` l√† `useLayoutEffect()` s·∫Ω ƒë∆∞·ª£c `g·ªçi ngay` sau khi DOM ƒë∆∞·ª£c c·∫≠p nh·∫≠t nh∆∞ng tr∆∞·ªõc khi tr√¨nh duy·ªát `render` l·∫°i giao di·ªán. Trong khi ƒë√≥, `useEffect()` s·∫Ω ƒë∆∞·ª£c g·ªçi sau khi tr√¨nh duy·ªát ƒë√£ `render` l·∫°i giao di·ªán.

- üëâ V√¨ v·∫≠y, n·∫øu b·∫°n mu·ªën th·ª±c hi·ªán c√°c `side-effect` li√™n quan ƒë·∫øn `k√≠ch th∆∞·ªõc`, `v·ªã tr√≠` c·ªßa ph·∫ßn t·ª≠ hay mu·ªën √°p d·ª•ng c√°c `thay ƒë·ªïi tr·ª±c ti·∫øp` l√™n DOM, th√¨ `useLayoutEffect()` l√† l·ª±a ch·ªçn t·ªët h∆°n. Tuy nhi√™n, c·∫ßn l∆∞u √Ω r·∫±ng s·ª≠ d·ª•ng `useLayoutEffect()` c√≥ th·ªÉ `g√¢y ch·∫≠m tr·ªÖ` cho trang web c·ªßa b·∫°n, do ƒë√≥ c·∫ßn c√¢n nh·∫Øc v√† s·ª≠ d·ª•ng m·ªôt c√°ch c·∫©n th·∫≠n.

**_- üëâ D∆∞·ªõi ƒë√¢y l√† m·ªôt v√≠ d·ª• ƒë∆°n gi·∫£n v·ªÅ c√°ch s·ª≠ d·ª•ng hook `useLayoutEffect()`:_**

```jsx
import React, { useLayoutEffect, useState } from "react";

function Example() {
  const [width, setWidth] = useState(0);

  useLayoutEffect(() => {
    const handleResize = () => {
      setWidth(window.innerWidth);
    };
    window.addEventListener("resize", handleResize);
    handleResize(); // G√°n gi√° tr·ªã ban ƒë·∫ßu cho width
    return () => window.removeEventListener("resize", handleResize);
  }, []); // Ch·ªâ ch·∫°y effect m·ªôt l·∫ßn

  return <div>Width: {width}</div>;
}
```

- üëâ Trong v√≠ d·ª• tr√™n, hook `useLayoutEffect()` ƒë∆∞·ª£c s·ª≠ d·ª•ng ƒë·ªÉ `c·∫≠p nh·∫≠t` gi√° tr·ªã c·ªßa `width` khi k√≠ch th∆∞·ªõc tr√¨nh duy·ªát thay ƒë·ªïi. Khi hook ƒë∆∞·ª£c g·ªçi l·∫ßn ƒë·∫ßu ti√™n (m·ªôt l·∫ßn duy nh·∫•t do m·∫£ng tham s·ªë th·ª© 2 l√† m·ªôt m·∫£ng r·ªóng), gi√° tr·ªã ban ƒë·∫ßu c·ªßa `width` s·∫Ω ƒë∆∞·ª£c g√°n b·∫±ng k√≠ch th∆∞·ªõc c·ªßa c·ª≠a s·ªï tr√¨nh duy·ªát. Sau ƒë√≥, m·ªôt `event listener` s·∫Ω ƒë∆∞·ª£c th√™m v√†o ƒë·ªÉ l·∫Øng nghe s·ª± ki·ªán `resize` c·ªßa tr√¨nh duy·ªát v√† `c·∫≠p nh·∫≠t` gi√° tr·ªã c·ªßa `width`. Khi component b·ªã `unmount`, `event listener` s·∫Ω ƒë∆∞·ª£c lo·∫°i b·ªè ƒë·ªÉ tr√°nh `leak memory`.

## D∆∞·ªõi ƒë√¢y l√† m·ªôt s·ªë v√≠ d·ª• c∆° b·∫£n v·ªÅ useLayoutEffect v√† gi·∫£i th√≠ch code chi ti·∫øt ƒë·ªÉ b·∫°n hi·ªÉu r√µ h∆°n:

**- üëâ V√≠ d·ª• 1: S·ª≠ d·ª•ng useLayoutEffect ƒë·ªÉ ƒë·∫£m b·∫£o t√≠nh nh·∫•t qu√°n c·ªßa giao di·ªán.**

```jsx
import { useState, useLayoutEffect } from "react";

function Component() {
  const [color, setColor] = useState("red");

  useLayoutEffect(() => {
    setColor("blue");
  }, []);

  return (
    <div style={{ backgroundColor: color }}>
      <h1>Hello world!</h1>
    </div>
  );
}
```

- üëâ ·ªû v√≠ d·ª• n√†y, ch√∫ng ta s·ª≠ d·ª•ng useState hook ƒë·ªÉ kh·ªüi t·∫°o m·ªôt state color v√† s·ª≠ d·ª•ng useLayoutEffect hook ƒë·ªÉ thay ƒë·ªïi gi√° tr·ªã c·ªßa state color th√†nh m√†u xanh (blue) khi component ƒë∆∞·ª£c render l·∫ßn ƒë·∫ßu ti√™n (v√¨ ch√∫ng ta truy·ªÅn m·ªôt m·∫£ng r·ªóng l√†m tham s·ªë th·ª© hai cho useLayoutEffect). Tuy nhi√™n, ch√∫ng ta kh√¥ng s·ª≠ d·ª•ng useEffect m√† s·ª≠ d·ª•ng useLayoutEffect ƒë·ªÉ ƒë·∫£m b·∫£o r·∫±ng thay ƒë·ªïi m√†u s·∫Øc c·ªßa component ƒë∆∞·ª£c √°p d·ª•ng ngay l·∫≠p t·ª©c m√† kh√¥ng c√≥ delay.

**- üëâ V√≠ d·ª• 2: S·ª≠ d·ª•ng useLayoutEffect ƒë·ªÉ t√≠nh to√°n v·ªã tr√≠ c·ªßa element trong DOM.**

```jsx
import { useState, useLayoutEffect, useRef } from "react";

function Component() {
  const [position, setPosition] = useState({ x: 0, y: 0 });
  const ref = useRef();

  useLayoutEffect(() => {
    const { x, y } = ref.current.getBoundingClientRect();
    setPosition({ x, y });
  }, []);

  return (
    <div ref={ref}>
      <h1>
        My position is ({position.x}, {position.y})
      </h1>
    </div>
  );
}
```

- üëâ ·ªû v√≠ d·ª• n√†y, ch√∫ng ta s·ª≠ d·ª•ng `useState` hook ƒë·ªÉ kh·ªüi t·∫°o m·ªôt `state position` v√† s·ª≠ d·ª•ng `useLayoutEffect` hook ƒë·ªÉ `t√≠nh to√°n` v·ªã tr√≠ c·ªßa `element` ƒë∆∞·ª£c `tham chi·∫øu` b·ªüi `ref` (s·ª≠ d·ª•ng h√†m `getBoundingClientRect()`) v√† c·∫≠p nh·∫≠t gi√° tr·ªã c·ªßa `state position`. Ch√∫ng ta s·ª≠ d·ª•ng m·ªôt m·∫£ng r·ªóng l√†m tham s·ªë th·ª© hai cho `useLayoutEffect` ƒë·ªÉ ƒë·∫£m b·∫£o r·∫±ng `t√≠nh to√°n` ƒë∆∞·ª£c th·ª±c hi·ªán ngay sau khi component ƒë∆∞·ª£c render l·∫ßn ƒë·∫ßu ti√™n.

**_> Nh·ªØng v√≠ d·ª• tr√™n ƒë·ªÅu l√† nh·ªØng v√≠ d·ª• c∆° b·∫£n v·ªÅ `useLayoutEffect` v√† gi·∫£i th√≠ch code chi ti·∫øt ƒë·ªÉ b·∫°n hi·ªÉu r√µ h∆°n v·ªÅ c√°ch s·ª≠ d·ª•ng n√≥._**
